public void calculateCommission(Policy policy, Map<String, Object> htPolicy) {
    try {
        List<Location> locList = policy.getLocationList();
        Map<Double, Double> comMap = new HashMap<>();
        
        // Process each location
        locList.forEach(loc -> {
            Map<String, LocationValue> locVal = loc.getLocationValues();
            
            // Process each location value
            locVal.forEach((key, locValue) -> {
                double locValComm = 0.0;
                try {
                    if (locValue != null && locValue.getLocCommision() != null && 
                        !locValue.getLocCommision().trim().isEmpty()) {
                        locValComm = Double.parseDouble(locValue.getLocCommision().trim());
                    }
                } catch (NumberFormatException e) {
                    log.error("Invalid location commission value: " + locValue.getLocCommision());
                }
                
                double locValPrem = 0.0;
                try {
                    if (locValue != null && locValue.getLocPremium() != null && 
                        !locValue.getLocPremium().trim().isEmpty()) {
                        locValPrem = Double.parseDouble(locValue.getLocPremium().trim());
                    }
                } catch (NumberFormatException e) {
                    log.error("Invalid location premium value: " + locValue.getLocPremium());
                }
                
                // Aggregate premiums by commission rate
                comMap.compute(locValComm, (k, v) -> (v == null ? 0d : v) + locValPrem);
            });
        });
        
        // Populate the result map
        int i = 0;
        for (Map.Entry<Double, Double> entry : comMap.entrySet()) {
            htPolicy.put("feerate" + i, entry.getKey());
            htPolicy.put("premium" + i, entry.getValue());
            i++;
        }
    } catch (Exception e) {
        log.error("ERROR: IICESSGI Util: calculateCommission", e);
    }
}
