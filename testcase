# Comparison of Debit Card vs. Commercial Credit Card Authentication Flows

Based on the analysis of the provided code, here's a detailed comparison between the authentication flows for debit cards (retail customers) and credit cards (commercial customers):

## Common Authentication Steps (Both Flows)

1. **Initial Validation**:
   - Card number format validation (16 digits)
   - Mod-10 check (Luhn algorithm)
   - Password length validation (8-13 characters)
   - HTTP Referer validation
   - BIN range validation

2. **ISDS Credential Verification**:
   - Retrieve credential information from ISDS
   - Determine credential type and status

3. **Basic Checks**:
   - Card registration status validation
   - Card status check (compromised, captured, inactive, etc.)

4. **Authentication**:
   - ISDS-based or database-based authentication
   - RSA Query to verify user registration status
   - RSA Analyze for risk assessment

5. **Risk-Based Flow**:
   - Different paths for ALLOW, CHALLENGE, and DENY policies
   - Event publishing for auditing

## Key Differences Between Flows

| Feature | Debit Card (Retail) | Commercial Credit Card |
|---------|---------------------|------------------------|
| **Customer Type** | "P" (Personal) | "0" (Organization) later converted to "Commercial" |
| **Customer Identifier** | Varies based on card type | Fixed as "COMMERCIAL_DEBIT_CARD" |
| **OTP Lock Check** | Required - calls `validateOTPLockStatus()` | Skipped - "Skip validateOTPLock for commercial card" |
| **TMX Integration** | Performs fraud detection with ThreatMetrix | Skipped - `userStatus = null` for commercial cards |
| **Challenge Flow** | Uses OTP challenge through `setAuthenticationResponseHeaderWhenOTPChallenge()` | Uses RSA challenge through `rsaChallenge()` API |
| **Header Management** | Standard retail headers | Includes proxy ID for commercial customers |
| **Proxy ID** | Not required | Retrieved from `getProxyId()` via Party Identification service |
| **Auth Level** | Level "4" for ALLOW, Level "2" for CHALLENGE | Level "5" for ALLOW (commercial) |

## Detailed Flow Differences

### Debit Card (Retail) Specific Steps:

1. **OTP Verification**:
   - Validates OTP lock status to ensure account isn't locked due to failed OTP attempts
   - Sets retail-specific MFA methods in headers

2. **TMX Fraud Detection**:
   - Integrates with ThreatMetrix for fraud scoring
   - Passes TMX data to RSA for risk assessment

3. **Challenge Handling**:
   - When RSA returns CHALLENGE policy, initiates OTP challenge
   - Sets `x_bmo_retcan_mfa_methods` with available MFA methods
   - Uses `EventStatus.ATTEMPT` for event publishing

### Commercial Credit Card Specific Steps:

1. **Customer Type Handling**:
   - Identifies "0" as commercial customer type
   - Explicitly validates with `validateCustomerType()` instead of `checkCustomerType()`

2. **Proxy ID Retrieval**:
   - For ALLOW policy, retrieves proxy ID from Party Identification service
   - Adds proxy ID to response headers with `x_bmo_proxyid`

3. **Challenge Handling**:
   - When RSA returns CHALLENGE policy, calls `rsaChallenge()` API
   - Sets different headers with `setAuthenticationResponseHeaderVerifyChallenge()`
   - Uses `EventStatus.SUCCESS` for event publishing (different from retail flow)

4. **Company Information**:
   - Extracts company name instead of first/last name
   - Uses different header population for commercial entities

## Implementation Details

1. **Code Conditionals**:
   ```java
   if ("COMMERCIAL_DEBIT_CARD".equalsIgnoreCase(customerIdentifier)) {
       logger.info("|Skip validateOTPLock for commercial card |");
   } else {
       // OTP lock validation for retail customers
   }
   ```

2. **Header Setting**:
   ```java
   // Commercial specific headers
   if (customerType.equalsIgnoreCase(AppConstants.CUSTOMER_TYPE_COMMERCIAL)) {
       headers.add("x_bmo_proxyid", proxyId);
       // Different auth level for commercial
       headers.put("am-eai-auth-level", Arrays.asList("5"));
   } else {
       // Retail specific headers
       headers.put("am-eai-auth-level", Arrays.asList("4"));
   }
   ```

3. **TMX Handling**:
   ```java
   // Skip TMX call for commercial card
   if ("COMMERCIAL_DEBIT_CARD".equalsIgnoreCase(customerIdentifier)) {
       logger.info("|Setting userStatus to null for commercial card");
       tmxParam.setUserStatus(null);
   }
   ```

## Conclusion

The authentication service implements a sophisticated dual-track system that caters to both retail debit card users and commercial credit card users. While the core validation and authentication logic remains similar, key differences exist in fraud detection, multi-factor authentication methods, and session/header management to accommodate the different security needs and usage patterns of these distinct customer types.

The commercial credit card flow emphasizes organizational identity (proxy ID) and uses a specialized challenge mechanism, while the retail debit card flow integrates additional fraud detection (TMX) and standardized OTP challenges for consumer-oriented security.
